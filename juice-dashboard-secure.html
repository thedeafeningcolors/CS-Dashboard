<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Juice - Task Dashboard (Secure)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .login-screen {
            max-width: 400px;
            margin: 100px auto;
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .login-screen h1 {
            text-align: center;
            color: #f0f0f0;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #424242;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .login-btn:hover {
            background-color: #1976d2;
        }
        
        .login-btn:disabled {
            background-color: #424242;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ef5350;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }
        
        .info-text {
            color: #b0b0b0;
            font-size: 13px;
            margin-top: 15px;
            line-height: 1.4;
        }
        
        .logout-section {
            text-align: right;
            margin-bottom: 20px;
        }
        
        .logout-btn {
            background-color: #424242;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background-color: #616161;
        }
        
        .main-content {
            display: none;
        }
        
        h1 {
            color: #f0f0f0;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #ffffff;
        }
        
        .status.loading {
            background-color: #1e3a5f;
        }
        
        .status.error {
            background-color: #4a1c1c;
        }
        
        .status.success {
            background-color: #1b4332;
        }
        
        .task-filters {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #2196f3;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        button:hover {
            background-color: #1976d2;
        }
        
        button.secondary {
            background-color: #424242;
        }
        
        button.secondary:hover {
            background-color: #616161;
        }
        
        .gmail-button {
            background-color: #ea4335;
        }
        
        .gmail-button:hover {
            background-color: #d33b2c;
        }
        
        .task-list {
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .task-item {
            padding: 15px 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background-color 0.2s;
            justify-content: space-between;
        }
        
        .task-item:hover {
            background-color: #333333;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #2196f3;
        }
        
        .task-details {
            flex-grow: 1;
        }
        
        .task-title {
            font-weight: 600;
            color: #f0f0f0;
            margin-bottom: 5px;
        }
        
        .task-meta {
            font-size: 14px;
            color: #b0b0b0;
        }
        
        .task-due {
            font-weight: 500;
        }
        
        .overdue {
            color: #ef5350;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .quick-task-form {
            background-color: #1e3a5f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #2a5490;
        }
        
        .quick-task-form.show {
            display: block;
        }
        
        .current-task-box {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #3a3a3a;
        }
        
        .current-task-box h3 {
            color: #ffffff;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .current-task-content {
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .current-task-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .form-section {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #3a3a3a;
        }
        
        .form-section h4 {
            color: #ffffff;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .form-row input,
        .form-row textarea {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #424242;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .form-row input:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .form-row label {
            min-width: 100px;
            font-weight: 500;
            color: #b0b0b0;
        }
        
        .contact-info {
            background-color: #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #3a3a3a;
        }
        
        .contact-info .info-row {
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        
        .contact-history {
            background-color: #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
        }
        
        .contact-history h4 {
            color: #ffffff;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .history-section {
            margin-bottom: 15px;
        }
        
        .history-section h5 {
            margin: 0 0 10px 0;
            color: #64b5f6;
            font-size: 14px;
        }
        
        .history-item {
            font-size: 13px;
            color: #b0b0b0;
            margin-bottom: 5px;
            padding-left: 15px;
        }
        
        /* NCES Data Panel Styles */
        .nces-data-panel {
            background-color: #2a2a2a;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #3a3a3a;
        }
        
        .nces-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            color: #64b5f6;
        }
        
        .nces-header:hover {
            color: #90caf9;
        }
        
        .nces-toggle {
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .nces-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .nces-content {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #3a3a3a;
        }
        
        .nces-content.show {
            display: block;
        }
        
        .nces-item {
            margin: 5px 0;
            padding-left: 20px;
            font-size: 14px;
            color: #e0e0e0;
        }
        
        .nces-item strong {
            color: #f0f0f0;
        }
        
        .school-breakdown {
            background-color: #1a1a1a;
            padding: 10px;
            margin: 10px 0 10px 20px;
            border-radius: 5px;
            border: 1px solid #424242;
            display: none;
        }
        
        .school-breakdown.show {
            display: block;
        }
        
        .school-group {
            margin-bottom: 15px;
        }
        
        .school-group h5 {
            margin: 0 0 8px 0;
            color: #64b5f6;
        }
        
        .school-item {
            margin: 4px 0;
            padding-left: 15px;
            font-size: 13px;
            color: #b0b0b0;
        }
        
        /* District Selection Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-content {
            background-color: #2a2a2a;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f0f0f0;
        }
        
        .selection-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .selection-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #333333;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .selection-item:hover {
            background-color: #424242;
        }
        
        .selection-item .main-text {
            font-weight: 600;
            color: #f0f0f0;
        }
        
        .selection-item .sub-text {
            font-size: 13px;
            color: #b0b0b0;
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #424242;
            border-top: 2px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tags {
            display: inline-flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tag {
            background-color: #424242;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #e0e0e0;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .mark-complete-button {
            background-color: #d84315;
        }
        
        .mark-complete-button:hover {
            background-color: #bf360c;
        }
        
        .add-task-button {
            background-color: #fbc02d;
            color: #333;
        }
        
        .add-task-button:hover {
            background-color: #f9a825;
        }
        
        .success-button {
            background-color: #66bb6a;
        }
        
        .success-button:hover {
            background-color: #4caf50;
        }
        
        .email-section {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #3a3a3a;
        }
        
        .email-section h4 {
            color: #ffffff;
            margin: 0 0 15px 0;
            font-weight: 600;
        }
        
        .ai-button {
            background-color: #4caf50;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-button:hover {
            background-color: #45a049;
        }
        
        .context-preview {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #424242;
            color: #e0e0e0;
        }
        
        .copy-success {
            color: #4caf50;
            font-weight: 700;
            margin-left: 10px;
            display: none;
        }
        
        .nces-button {
            background-color: #8b0000;
            margin-left: 10px;
        }
        
        .nces-button:hover {
            background-color: #6b0000;
        }
        
        /* Date input styling */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            margin-right: 4px;
            margin-left: -20px;
        }
        
        /* Scrollbar styling for dark mode */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Input placeholder styling */
        input::placeholder,
        textarea::placeholder {
            color: #666;
        }
        
        /* Expanded task item for follow-up form */
        .task-item.expanded {
            background-color: #f39c12;
            color: #1a1a1a;
        }
        
        .task-item.expanded .task-title,
        .task-item.expanded .task-meta,
        .task-item.expanded .task-contact,
        .task-item.expanded .task-due {
            color: #1a1a1a;
        }
        
        .task-item.expanded .overdue {
            color: #c62828;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <h1>The Juice Task Dashboard</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="apiKey">FreshSales API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your FreshSales API key" required>
            </div>
            <div class="form-group">
                <label for="baseDomain">Base Domain (optional)</label>
                <input type="text" id="baseDomain" placeholder="your-domain.myfreshworks.com" value="thejuice-439787933003515753.myfreshworks.com">
            </div>
            <button type="submit" class="login-btn" id="loginBtn">Access Dashboard</button>
            <div id="loginError" class="error-message"></div>
            <div class="info-text">
                <strong>How to find your API key:</strong><br>
                1. Log into your FreshSales account<br>
                2. Go to Settings → API Settings<br>
                3. Copy your API key<br><br>
                Your API key is stored securely in your browser and never shared.
            </div>
        </form>
    </div>

    <!-- Main Dashboard -->
    <div id="mainContent" class="main-content">
        <div class="container">
            <div class="logout-section">
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
            
            <h1>The Juice Task Dashboard</h1>
            
            <div id="status" class="status loading">Loading tasks...</div>
            
            <div class="task-filters">
                <button onclick="loadTasks('open')">Open Tasks</button>
                <button onclick="loadTasks('due_today')" class="secondary">Due Today</button>
                <button onclick="loadTasks('overdue')" class="secondary">Overdue</button>
                <button onclick="loadTasks('completed')" class="secondary">Completed</button>
            </div>
            
            <div id="taskList" class="task-list"></div>
        </div>
    </div>
    
    <!-- District Selection Modal -->
    <div id="districtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Select District</div>
            <div class="selection-list" id="selectionList"></div>
            <button onclick="closeModal()" class="secondary" style="margin-top: 10px;">Cancel</button>
        </div>
    </div>
    
    <script>
        // Configuration
        let API_KEY = '';
        let BASE_URL = '';
        const CALENDLY_LINK = 'https://calendly.com/cris-at-the-juice/30min';
        
        // Google Sheets configuration
        const SHEET_ID = '1tQjQRRgGIpWan8sGM-VznFc0WZwGn4pnupS3c8aTlAE';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
        
        // Global variables
        let currentFilter = 'open';
        let tasks = [];
        let fullContactHistory = {};
        let ncesData = [];
        let currentNCESMatches = [];
        let districtMemory = {};
        let includeNCESInContext = false;
        let currentContactEmail = '';
        let currentOtherContacts = [];
        let currentTaskElement = null;
        
        // Initialize app
        window.onload = () => {
            checkStoredCredentials();
        };
        
        // Check if user has stored credentials
        function checkStoredCredentials() {
            try {
                const storedApiKey = localStorage.getItem('freshsales_api_key');
                const storedDomain = localStorage.getItem('freshsales_domain');
                
                if (storedApiKey && storedDomain) {
                    API_KEY = storedApiKey;
                    BASE_URL = storedDomain + '/crm/sales';
                    showMainContent();
                    loadTasks('open');
                    loadNCESData();
                } else {
                    showLoginScreen();
                }
            } catch (e) {
                console.error('Error checking stored credentials:', e);
                showLoginScreen();
            }
        }
        
        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
        
        // Show main content
        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Set default due date to tomorrow at 9 AM for any forms
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            const quickDueDateField = document.getElementById('quickDueDate');
            if (quickDueDateField) {
                quickDueDateField.value = tomorrow.toISOString().slice(0, 16);
            }
        }
        
        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const apiKey = document.getElementById('apiKey').value.trim();
            const domain = document.getElementById('baseDomain').value.trim() || 'thejuice-439787933003515753.myfreshworks.com';
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            if (!apiKey) {
                errorDiv.textContent = 'Please enter your API key';
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Verifying...';
            errorDiv.textContent = '';
            
            // Test the API key by making a simple request
            try {
                const testUrl = `https://cors-anywhere.herokuapp.com/https://${domain}/crm/sales/api/tasks?per_page=1`;
                const response = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Token token=${apiKey}`,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    // Store credentials
                    localStorage.setItem('freshsales_api_key', apiKey);
                    localStorage.setItem('freshsales_domain', domain);
                    
                    API_KEY = apiKey;
                    BASE_URL = domain + '/crm/sales';
                    
                    showMainContent();
                    loadTasks('open');
                    loadNCESData();
                } else {
                    throw new Error('Invalid API key or domain');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Invalid API key or domain. Please check your credentials.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Access Dashboard';
            }
        });
        
        // Logout function
        function logout() {
            localStorage.removeItem('freshsales_api_key');
            localStorage.removeItem('freshsales_domain');
            API_KEY = '';
            BASE_URL = '';
            showLoginScreen();
            document.getElementById('apiKey').value = '';
        }
        
        // Load saved district memory from localStorage
        try {
            const savedMemory = localStorage.getItem('districtMemory');
            if (savedMemory) {
                districtMemory = JSON.parse(savedMemory);
            }
        } catch (e) {
            console.error('Error loading district memory:', e);
        }
        
        // Load NCES data from Google Sheets
        async function loadNCESData() {
            try {
                console.log('Loading NCES data from Google Sheets...');
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                ncesData = parseCSV(csvText);
                console.log(`Loaded ${ncesData.length} NCES records`);
                
                // Log a few sample district names for debugging
                if (ncesData.length > 0) {
                    console.log('Sample district names from NCES:');
                    for (let i = 0; i < Math.min(5, ncesData.length); i++) {
                        if (ncesData[i]['Account']) {
                            console.log(`  - "${ncesData[i]['Account']}" (${ncesData[i]['State Abbreviation']})`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading NCES data:', error);
                console.log('Trying alternative method...');
                // Try with CORS proxy as backup
                try {
                    const proxyUrl = `https://cors-anywhere.herokuapp.com/${SHEET_URL}`;
                    const response = await fetch(proxyUrl);
                    const csvText = await response.text();
                    ncesData = parseCSV(csvText);
                    console.log(`Loaded ${ncesData.length} NCES records via proxy`);
                } catch (proxyError) {
                    console.error('Proxy method also failed:', proxyError);
                }
            }
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        // Clean district name for matching
        function cleanDistrictName(name) {
            if (!name) return '';
            
            const suffixes = [
                'Public Schools', 'Public School', 'School District', 'Schools',
                'School', 'District', 'USD', 'ISD', 'CISD', 'CSD', 'SD',
                'Community School District', 'Central School District',
                'Union Free School District', 'Consolidated School District',
                'Parish Schools', 'County School District', 'BOCES',
                'Intermediate Unit', 'Independent School District',
                'School Corporation', 'PS', 'SD'
            ];
            
            let cleaned = name.trim();
            
            // Remove suffixes
            suffixes.forEach(suffix => {
                const regex = new RegExp('\\s+' + suffix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$', 'i');
                cleaned = cleaned.replace(regex, '');
            });
            
            return cleaned.trim().toLowerCase();
        }
        
        // Find matching districts
        function findMatchingDistricts(searchTerm) {
            if (!searchTerm || ncesData.length === 0) {
                console.log('No search term or NCES data not loaded');
                return [];
            }
            
            // Extract state abbreviation if present in parentheses
            let stateFilter = null;
            const stateMatch = searchTerm.match(/\(([A-Z]{2})\)$/);
            if (stateMatch) {
                stateFilter = stateMatch[1];
                searchTerm = searchTerm.replace(/\s*\([A-Z]{2}\)$/, '').trim();
            }
            
            const cleaned = cleanDistrictName(searchTerm);
            console.log(`Searching for: "${searchTerm}" (cleaned: "${cleaned}")${stateFilter ? ' in state: ' + stateFilter : ''}`);
            
            const matches = new Map();
            let debugCount = 0;
            
            ncesData.forEach(row => {
                const districtName = row['Account'];
                if (!districtName) return;
                
                // If state filter is provided, check it first
                if (stateFilter && row['State Abbreviation'] !== stateFilter) return;
                
                const cleanedDistrict = cleanDistrictName(districtName);
                
                // Log first few for debugging
                if (debugCount < 5 && stateFilter && row['State Abbreviation'] === stateFilter) {
                    console.log(`Sample ${stateFilter} district: "${districtName}" (cleaned: "${cleanedDistrict}")`);
                    debugCount++;
                }
                
                // Check for match - try multiple matching strategies
                let isMatch = false;
                
                // Exact match after cleaning
                if (cleanedDistrict === cleaned) {
                    isMatch = true;
                }
                // Contains match
                else if (cleanedDistrict.includes(cleaned) || cleaned.includes(cleanedDistrict)) {
                    isMatch = true;
                }
                // Word-by-word match (for cases like "Boston" matching "Boston Public Schools")
                else {
                    const searchWords = cleaned.split(/\s+/);
                    const districtWords = cleanedDistrict.split(/\s+/);
                    
                    // Check if all search words are in district name
                    if (searchWords.every(word => districtWords.includes(word))) {
                        isMatch = true;
                    }
                }
                
                if (isMatch) {
                    const key = `${row['State Abbreviation']}_${districtName}`;
                    if (!matches.has(key)) {
                        matches.set(key, {
                            districtName: districtName,
                            state: row['State Abbreviation'],
                            stateName: row['State Name'],
                            county: row['County Name'],
                            agencyId: row['Agency ID'],
                            schools: []
                        });
                    }
                    matches.get(key).schools.push(row);
                }
            });
            
            const results = Array.from(matches.values());
            console.log(`Found ${results.length} matches`);
            return results;
        }
        
        // Show district selection modal
        function showDistrictModal(matches, accountName) {
            const modal = document.getElementById('districtModal');
            const header = document.getElementById('modalHeader');
            const list = document.getElementById('selectionList');
            
            // Group by state
            const stateGroups = {};
            matches.forEach(match => {
                if (!stateGroups[match.state]) {
                    stateGroups[match.state] = [];
                }
                stateGroups[match.state].push(match);
            });
            
            // If multiple states, show state selection first
            if (Object.keys(stateGroups).length > 1) {
                header.textContent = `Multiple districts found matching "${accountName}"`;
                list.innerHTML = '<div style="margin-bottom: 10px;">Select state:</div>';
                
                Object.keys(stateGroups).sort().forEach(state => {
                    const div = document.createElement('div');
                    div.className = 'selection-item';
                    div.innerHTML = `
                        <div class="main-text">${stateGroups[state][0].stateName}</div>
                        <div class="sub-text">${stateGroups[state].length} district${stateGroups[state].length > 1 ? 's' : ''}</div>
                    `;
                    div.onclick = () => showDistrictsForState(stateGroups[state], accountName);
                    list.appendChild(div);
                });
            } else {
                // Single state, show districts directly
                showDistrictsForState(matches, accountName);
            }
            
            modal.classList.add('show');
        }
        
        // Show districts for a specific state
        function showDistrictsForState(districts, accountName) {
            const header = document.getElementById('modalHeader');
            const list = document.getElementById('selectionList');
            
            if (districts.length === 1) {
                selectDistrict(districts[0], accountName);
                closeModal();
                return;
            }
            
            header.textContent = `Select district in ${districts[0].stateName}:`;
            list.innerHTML = '';
            
            districts.forEach(district => {
                const div = document.createElement('div');
                div.className = 'selection-item';
                div.innerHTML = `
                    <div class="main-text">${district.districtName}</div>
                    <div class="sub-text">${district.county} County • ${district.schools.length} schools</div>
                `;
                div.onclick = () => {
                    selectDistrict(district, accountName);
                    closeModal();
                };
                list.appendChild(div);
            });
        }
        
        // Select a district and display data
        function selectDistrict(district, accountName) {
            // Save to memory
            districtMemory[cleanDistrictName(accountName)] = district.agencyId;
            localStorage.setItem('districtMemory', JSON.stringify(districtMemory));
            
            // Display the data
            displayNCESData(district);
        }
        
        // Display NCES data in the panel
        function displayNCESData(district) {
            const panel = document.getElementById('ncesDataPanel');
            const display = document.getElementById('ncesDataDisplay');
            
            // Calculate statistics
            let totalStudents = 0;
            let juiceStudents = 0;
            let schoolsWithJuice = 0;
            let elementaryWithJuice = [];
            let middleSchools = [];
            let highSchools = [];
            
            district.schools.forEach(school => {
                const total = parseInt(school['Total Students']) || 0;
                totalStudents += total;
                
                // Calculate Juice students (G5-12)
                let schoolJuiceStudents = 0;
                for (let grade = 5; grade <= 12; grade++) {
                    const gradeCol = grade <= 8 ? `G${grade}-Students` : `G${grade}-Students`;
                    schoolJuiceStudents += parseInt(school[gradeCol]) || 0;
                }
                juiceStudents += schoolJuiceStudents;
                
                if (schoolJuiceStudents > 0) {
                    schoolsWithJuice++;
                    
                    const schoolInfo = {
                        name: school['School Name'],
                        id: school['School ID (12-digit)'],
                        juiceStudents: schoolJuiceStudents,
                        totalStudents: total,
                        level: school['School Level']
                    };
                    
                    if (school['School Level'].includes('Middle')) {
                        middleSchools.push(schoolInfo);
                    } else if (school['School Level'].includes('High')) {
                        highSchools.push(schoolInfo);
                    } else if (school['School Level'].includes('Elementary') && schoolJuiceStudents > 0) {
                        elementaryWithJuice.push(schoolInfo);
                    }
                }
            });
            
            const juicePercent = totalStudents > 0 ? Math.round((juiceStudents / totalStudents) * 100) : 0;
            
            // Determine Title I status
            let titleIStatus = 'Not Title I';
            const firstSchool = district.schools[0];
            if (firstSchool['National School Lunch Program']) {
                if (firstSchool['National School Lunch Program'].includes('Community Eligibility')) {
                    titleIStatus = 'High-poverty district (100% eligible)';
                } else if (firstSchool['National School Lunch Program'].toLowerCase() === 'yes') {
                    titleIStatus = 'Title I eligible';
                }
            }
            
            // Build display HTML
            let html = `
                <div class="nces-item"><strong>District:</strong> ${district.districtName} (ID: ${district.agencyId})</div>
                <div class="nces-item"><strong>Location:</strong> ${district.county}, ${district.state}</div>
                <div class="nces-item"><strong>Total Students:</strong> ${totalStudents.toLocaleString()}</div>
                <div class="nces-item"><strong>Juice Students (G5-12):</strong> ${juiceStudents.toLocaleString()} (${juicePercent}%)</div>
                <div class="nces-item"><strong>Schools with Juice Grades:</strong> ${schoolsWithJuice} of ${district.schools.length} total</div>
                <div class="nces-item" style="padding-left: 40px;">
                    <a href="javascript:void(0)" onclick="toggleSchoolBreakdown()" style="color: #64b5f6; text-decoration: none;">
                        <span id="schoolToggle">▶</span> Show school breakdown
                    </a>
                </div>
                <div id="schoolBreakdown" class="school-breakdown">
            `;
            
            if (middleSchools.length > 0) {
                html += '<div class="school-group"><h5>Middle Schools (' + middleSchools.length + '):</h5>';
                middleSchools.forEach(school => {
                    html += `<div class="school-item">• ${school.name} (ID: ${school.id})<br>&nbsp;&nbsp;└─ ${school.juiceStudents} Juice students</div>`;
                });
                html += '</div>';
            }
            
            if (elementaryWithJuice.length > 0) {
                html += '<div class="school-group"><h5>Elementary with G5-6 (' + elementaryWithJuice.length + '):</h5>';
                elementaryWithJuice.forEach(school => {
                    html += `<div class="school-item">• ${school.name} (ID: ${school.id})<br>&nbsp;&nbsp;└─ ${school.juiceStudents} Juice students in G5-6 (of ${school.totalStudents} total)</div>`;
                });
                html += '</div>';
            }
            
            if (highSchools.length > 0) {
                html += '<div class="school-group"><h5>High Schools (' + highSchools.length + '):</h5>';
                highSchools.forEach(school => {
                    html += `<div class="school-item">• ${school.name} (ID: ${school.id})<br>&nbsp;&nbsp;└─ ${school.juiceStudents} Juice students (G9-12)</div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            html += `<div class="nces-item"><strong>Title I:</strong> ${titleIStatus}</div>`;
            
            // Add address and website if available
            if (firstSchool['Street Address']) {
                html += `<div class="nces-item"><strong>Address:</strong> ${firstSchool['Street Address']}, ${firstSchool['City']}, ${firstSchool['State Abbreviation']} ${firstSchool['Zip Code']}</div>`;
            }
            if (firstSchool['Web Site URL']) {
                const url = firstSchool['Web Site URL'].trim();
                // Ensure URL has protocol
                const fullUrl = url.startsWith('http') ? url : `http://${url}`;
                html += `<div class="nces-item"><strong>Website:</strong> <a href="${fullUrl}" target="_blank" style="color: #64b5f6;">${url}</a></div>`;
            }
            
            display.innerHTML = html;
            panel.style.display = 'block';
            
            // Store current matches for context generation
            currentNCESMatches = district;
        }
        
        // Toggle NCES panel visibility
        function toggleNCESPanel() {
            const toggle = document.getElementById('ncesToggle');
            const content = document.getElementById('ncesContent');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('show');
                toggle.classList.add('expanded');
            }
        }
        
        // Toggle school breakdown visibility
        function toggleSchoolBreakdown() {
            const breakdown = document.getElementById('schoolBreakdown');
            const toggle = document.getElementById('schoolToggle');
            
            if (breakdown.classList.contains('show')) {
                breakdown.classList.remove('show');
                toggle.textContent = '▶';
            } else {
                breakdown.classList.add('show');
                toggle.textContent = '▼';
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('districtModal').classList.remove('show');
        }
        
        // Simple Gmail open
        function openGmailSimple() {
            if (currentContactEmail) {
                let gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(currentContactEmail)}`;
                
                // Add CC if there are other contacts
                if (currentOtherContacts.length > 0) {
                    const ccEmails = currentOtherContacts.map(c => c.email).filter(e => e).join(',');
                    if (ccEmails) {
                        gmailUrl += `&cc=${encodeURIComponent(ccEmails)}`;
                    }
                }
                
                window.open(gmailUrl, '_blank');
            } else {
                window.open('https://mail.google.com/', '_blank');
            }
        }
        
        // Gmail compose for specific task
        function openGmailForTask(email) {
            window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}`, '_blank');
        }
        
        async function loadTasks(filter) {
            if (!API_KEY || !BASE_URL) {
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'Please log in first';
                return;
            }
            
            currentFilter = filter;
            const status = document.getElementById('status');
            const taskList = document.getElementById('taskList');
            
            status.className = 'status loading';
            status.textContent = 'Loading tasks...';
            taskList.innerHTML = '';
            
            try {
                const url = `https://cors-anywhere.herokuapp.com/https://${BASE_URL}/api/tasks?filter=${filter}&include=targetable`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Token token=${API_KEY}`,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                tasks = data.tasks || [];
                
                status.className = 'status success';
                status.textContent = `Found ${tasks.length} ${filter.replace('_', ' ')} tasks`;
                
                if (tasks.length === 0) {
                    taskList.innerHTML = '<div class="task-item"><div class="task-details">No tasks found</div></div>';
                } else {
                    tasks.forEach(task => {
                        taskList.appendChild(createTaskElement(task, data.contacts, data.sales_accounts));
                    });
                }
            } catch (error) {
                console.error('Full error:', error);
                status.className = 'status error';
                status.textContent = `Error: CORS proxy may need activation. Visit https://cors-anywhere.herokuapp.com/corsdemo and click "Request temporary access"`;
            }
        }
        
        function createTaskElement(task, contacts, accounts) {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.id = `task-${task.id}`;
            
            // Find the related contact/account
            let targetName = 'Unknown';
            let targetInfo = null;
            let targetEmail = '';
            
            if (task.targetable) {
                if (task.targetable.type === 'contact' && contacts) {
                    targetInfo = contacts.find(c => c.id === task.targetable.id);
                    targetName = targetInfo ? targetInfo.display_name : 'Contact';
                    targetEmail = targetInfo?.email || '';
                } else if (task.targetable.type === 'sales_account' && accounts) {
                    targetInfo = accounts.find(a => a.id === task.targetable.id);
                    targetName = targetInfo ? targetInfo.name : 'Account';
                }
            }
            
            // Format due date
            const dueDate = new Date(task.due_date);
            const now = new Date();
            const isOverdue = dueDate < now && task.status === 0;
            const dueDateStr = dueDate.toLocaleDateString() + ' ' + dueDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            
            // Properly escape strings for JavaScript
            const escapedTargetName = (targetName || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const escapedTitle = (task.title || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const escapedDescription = (task.description || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
            
            div.innerHTML = `
                <div class="task-details">
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        <span class="task-contact">${targetName}</span> • 
                        <span class="task-due ${isOverdue ? 'overdue' : ''}">${dueDateStr}</span>
                        ${task.description ? ` • <span style="color: #999; font-style: italic;">${task.description}</span>` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    ${task.status === 0 ? `
                        <button onclick="showQuickTaskForm('${escapedTargetName}', ${task.targetable?.id || 'null'}, '${task.targetable?.type || ''}', ${task.id}, '${escapedTitle}', '${escapedDescription}')">See Follow-up Options</button>
                        <button onclick="completeTaskOnly(${task.id})" class="secondary">Mark Task as Complete</button>
                    ` : ''}
                </div>
            `;
            
            return div;
        }
        
        async function completeTaskOnly(taskId) {
            if (!API_KEY || !BASE_URL) return;
            
            const status = document.getElementById('status');
            
            try {
                const url = `https://cors-anywhere.herokuapp.com/https://${BASE_URL}/api/tasks/${taskId}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token token=${API_KEY}`,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        task: { status: 1 }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                
                status.className = 'status success';
                status.textContent = 'Task completed!';
                
                // Reload tasks after 1 second
                setTimeout(() => loadTasks(currentFilter), 1000);
            } catch (error) {
                status.className = 'status error';
                status.textContent = `Error completing task: ${error.message}`;
            }
        }
        
        // Placeholder functions for forms that would be implemented similar to the original
        function showQuickTaskForm(contactName, contactId, contactType, originalTaskId, previousTitle, previousNotes) {
            alert('Task form functionality would be implemented here - this is a simplified secure version');
        }
        
        function toggleContactNoteField() {
            // Implementation would go here
        }
        
        function hideQuickTaskForm() {
            // Implementation would go here
        }
        
        async function updateContextPreview() {
            // Implementation would go here
        }
        
        async function fetchEmailsFor(email) {
            // Implementation would go here
            return [];
        }
        
        async function generateAndCopyAIContext() {
            alert('AI context generation would be implemented here');
        }
        
        async function generateAndCopyAIContextWithNCES() {
            alert('AI context with NCES generation would be implemented here');
        }
        
        function copyToClipboard(text) {
            // Implementation would go here
        }
        
        async function generateAIContextText(includeNCES) {
            return 'Context would be generated here';
        }
        
        async function createQuickTask(alsoCompleteOriginal) {
            // Implementation would go here
        }
    </script>
</body>
</html>